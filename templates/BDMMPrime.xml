<beast version='2.0'
       namespace='beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions'>

    <mergewith point='treePriorTemplates'>

        <subtemplate id='BDMMPrime' class='bdmmprime.distributions.BirthDeathMigrationDistribution' mainid='BDMMPrime.t:$(n)'
                     inlineInputs="bdmmprime.distributions.BirthDeathMigrationDistribution.parameterization"
                     suppressInputs="bdmmprime.distributions.BirthDeathMigrationDistribution.typeLabel,
                        bdmmprime.distributions.BirthDeathMigrationDistribution.storeNodeTypes,
                        bdmmprime.distributions.BirthDeathMigrationDistribution.tree">

            <plate var="param" range="Canonical">
            <![CDATA[
                <distribution id="BDMMPrime.t:$(n)" spec="bdmmprime.distributions.BirthDeathMigrationDistribution"
                              tree="@Tree.t:$(n)" conditionOnSurvival="false" parallelize="true">

                    <parameterization id="CanonicalBDMMPrimeParameterization.t:$(n)" spec="bdmmprime.parameterization.CanonicalParameterization">
                        <origin spec="beast.core.parameter.RealParameter" id="origin" value="10.0"/>
                        <typeSet id="typeSet" spec="bdmmprime.parameterization.TypeSet" typeTraitSet="@typeTraitSet.t:$(n)"/>
                        <birthRate spec="bdmmprime.parameterization.SkylineVectorParameter" typeSet="@typeSet">
                            <rateValues id="birthRate$(param).t:$(n)" spec='beast.core.parameter.RealParameter' value="1.0"/>
                        </birthRate>
                        <deathRate spec="bdmmprime.parameterization.SkylineVectorParameter" typeSet="@typeSet">
                            <rateValues id="deathRate$(param).t:$(n)" spec='beast.core.parameter.RealParameter' value="1.0"/>
                        </deathRate>
                        <migrationRate spec="bdmmprime.parameterization.SkylineMatrixParameter" typeSet="@typeSet">
                            <rateValues id="migrationRate$(param).t:$(n)" spec='beast.core.parameter.RealParameter' value="1.0"/>
                        </migrationRate>
                        <samplingRate spec="bdmmprime.parameterization.SkylineVectorParameter" typeSet="@typeSet">
                            <rateValues id="samplingRate$(param).t:$(n)" spec="beast.core.parameter.RealParameter" value="0.1"/>
                        </samplingRate>
                        <removalProb spec="bdmmprime.parameterization.SkylineVectorParameter" typeSet="@typeSet">
                            <rateValues id="removalProb$(param).t:$(n)" spec="beast.core.parameter.RealParameter" value="1.0" lower="0.0" upper="1.0" estimate="false"/>
                        </removalProb>
                    </parameterization>

                    <typeTraitSet id="typeTraitSet.t:$(n)" spec="bdmmprime.util.InitializedTraitSet" traitname="type" tree="@Tree.t:$(n)">
                        <taxa spec="beast.evolution.alignment.TaxonSet" alignment="@$(n)"/>
                    </typeTraitSet>

                    <frequencies id="typeFrequencies.t:$(n)" spec="beast.core.parameter.RealParameter" value="1.0"/>
                </distribution>

            ]]>
            </plate>

			<plate fragment="TreeOperators" var="m" range="BDMMPrime"/>


            <plate var="param" range="Canonical">
            <plate fragment="BDMMPrimeParameters" var="p"
                   range="birthRate$(param),deathRate$(param),migrationRate$(param),samplingRate$(param),removalProb$(param)"/>
            </plate>

            <connect srcID='BDMMPrime.t:$(n)' targetID='prior' inputName='distribution'
                    if='inposterior(BDMMPrime.t:$(n)) and inposterior(Tree.t:$(n)) and Tree.t:$(n)/estimate=true'>
                BDMM prior on tree t:$(n)
            </connect>
        </subtemplate>

    </mergewith>
</beast>


